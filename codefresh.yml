version: '1.0'
steps:
  build_docker_image:
    title: Building Docker Image
    type: build
    image_name: btodhunter/anchore-demo
    tag: ci
    working_directory: ./
    dockerfile: Dockerfile

  anchore_scan:
    type: composition
    title: Scanning with Anchore Engine
    composition:
      version: '2'
      services:
        anchore-engine:
          image: anchore/inline-scan:latest
          ports:
            - 8228
          command: bash -c 'docker-entrypoint.sh start &> /dev/null'
    composition_candidates:
      scan_image:
        image: anchore/inline-scan:latest
        links:
          - anchore-engine
        environment:
          - ANCHORE_CLI_URL=http://anchore-engine:8228/v1/
        command: bash -c 'anchore-cli system wait && anchore_ci_tools.py -a -r --image btodhunter/anchore-demo:ci'
      
  push_to_registry:
    title: Pushing to Docker Registry 
    type: push
    candidate: '${{build_docker_image}}'
    tag: codefresh
    registry: dockerhub